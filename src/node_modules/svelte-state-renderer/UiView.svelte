<script context="module">
  import { getContext, setContext, tick } from 'svelte'

  const ROUTING = Symbol('UiView.routing')
  const registerChild = Symbol('UiView.registerChild')

  export const getRouterContext = () => getContext(ROUTING)

</script>

<script>
  export let asr

  let props
  let Component
  let destroyed

  // --- Routing context ---

  if (asr) {
    setContext(ROUTING, { asr })
  } else {
    ({ asr } = getContext(ROUTING))
  }

  // --- API ---

  let childApi
  let component

  export const setComponent = async (newComponent, newProps) => {
    Component = newComponent
    props = newProps
    await tick()
    return component
  }

  export const getChild = () => childApi

  // --- Register itself to parent ---

  const register = getContext(registerChild)

  if (register) {
    const setAsr = x => {
      if (x !== asr) {
        throw new Error('Unexpected state: cannot change context')
      }
    }

    const $destroy = () => {
      destroyed = true
    }

    register({ setComponent, getChild, setAsr, $destroy })
  }

  // --- Expose register hook for child ---

  setContext(registerChild, api => {
    childApi = api
  })
</script>

{#if !destroyed}
  <svelte:component this={Component} bind:this={component} {...props} />
{/if}
