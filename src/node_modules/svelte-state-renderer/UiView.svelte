<script context="module">
  import { getContext, setContext, tick } from 'svelte'

  const registerChild = Symbol('UiView.registerChild')
</script>

<script>
  let props
  let Component
  let destroyed

  // --- API ---

  let childApi
  let component

  export const setComponent = async (newComponent, newProps) => {
    Component = newComponent
    props = newProps
    await tick()
    return component
  }

  export const getChild = () => childApi

  // --- Register itself to parent ---

  const register = getContext(registerChild)

  if (register) {
    const $destroy = () => {
      destroyed = true
    }
    const api = { setComponent, getChild, $destroy }
    register(api)
  }

  // --- Expose register hook for child ---

  setContext(registerChild, api => {
    childApi = api
  })
</script>

{#if !destroyed}
  <svelte:component this={Component} bind:this={component} {...props} />
{/if}
